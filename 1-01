import torch
import torch.nn.functional as F
import cv2
import numpy as np

# )
EMOTIONS = ["happy", "sad", "neutral", "angry", "surprised"]

def load_model(model_path="model/emotion_model.pt"):
    model = torch.load(model_path, map_location="cpu")
    model.eval()
    return model

def prepare_eye(eye_img):
    eye_img = cv2.resize(eye_img, (48, 48))
    eye_img = np.expand_dims(eye_img, axis=0)
    eye_img = eye_img / 255.0
    eye_tensor = torch.tensor(eye_img, dtype=torch.float32).unsqueeze(0)
    return eye_tensor

def predict_emotion(model, eye_img):
    tensor = prepare_eye(eye_img)
    with torch.no_grad():
        output = model(tensor)
        probs = F.softmax(output, dim=1)
        emotion_idx = probs.argmax().item()
        return EMOTIONS[emotion_idx], probs[0][emotion_idx].item()

def load_model(model_path="model/emotion_model.pt"):
    model = torch.load(model_path, map_location="cpu")
    model.eval()
    return model
